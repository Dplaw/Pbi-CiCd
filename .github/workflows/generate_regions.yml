name: Generate & Publish Power BI PBIP (Fabric)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'template/**'
      - 'config/**'
      - '.github/workflows/generate_regions.yml'

# Zapobiega rÃ³wnolegÅ‚ym pushom i updateFromGit
concurrency:
  group: generate-regions-main
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    # ðŸ”´ KLUCZOWE â€“ bez tego Environment secrets NIE DZIAÅAJÄ„
    environment: github-actions-powerbi

    steps:
      # ------------------------------------------------------------
      # Repo
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Python
      # ------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # ------------------------------------------------------------
      # Generate PBIP projects
      # ------------------------------------------------------------
      - name: Generate regional PBIP projects
        shell: bash
        run: |
          set -euo pipefail
          python scripts/generate_regions.py

      # ------------------------------------------------------------
      # Commit + push wygenerowanych zmian
      # ------------------------------------------------------------
      - name: Commit & push generated outputs (if changed)
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git checkout main
          git fetch origin main
          git pull --rebase origin main

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update regional PBIP outputs"

          for i in 1 2 3; do
            if git push origin main; then
              echo "Pushed successfully."
              exit 0
            fi
            echo "Push failed (attempt $i). Rebasing and retrying..."
            git fetch origin main
            git pull --rebase origin main
          done

          echo "Failed to push after retries."
          exit 1

      # ------------------------------------------------------------
      # Tools
      # ------------------------------------------------------------
      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      # ------------------------------------------------------------
      # Auth â€“ Entra ID (Service Principal)
      # ------------------------------------------------------------
      - name: Get Fabric access token
        id: fabric_token
        shell: bash
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
        run: |
          set -euo pipefail

          : "${AZURE_TENANT_ID:?Missing AZURE_TENANT_ID}"
          : "${AZURE_CLIENT_ID:?Missing AZURE_CLIENT_ID}"
          : "${AZURE_CLIENT_SECRET:?Missing AZURE_CLIENT_SECRET}"

          RESP="$(curl -fsS -X POST \
            "https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "client_id=${AZURE_CLIENT_ID}" \
            --data-urlencode "client_secret=${AZURE_CLIENT_SECRET}" \
            --data-urlencode "grant_type=client_credentials" \
            --data-urlencode "scope=https://api.fabric.microsoft.com/.default")"

          echo "$RESP" | jq . >/dev/null

          TOKEN="$(echo "$RESP" | jq -r '.access_token // empty')"
          if [ -z "$TOKEN" ]; then
            echo "Failed to obtain access token:"
            echo "$RESP" | jq .
            exit 1
          fi

          echo "token=$TOKEN" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Fabric â€“ Git status
      # ------------------------------------------------------------
      - name: Get Fabric Git status
        id: fabric_git_status
        shell: bash
        env:
          FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}
        run: |
          set -euo pipefail

          STATUS="$(curl -fsS -X POST \
            "https://api.fabric.microsoft.com/v1/workspaces/${FABRIC_WORKSPACE_ID}/git/getStatus" \
            -H "Authorization: Bearer ${{ steps.fabric_token.outputs.token }}" \
            -H "Content-Type: application/json")"

          echo "$STATUS" | jq .

          WORKSPACE_HEAD="$(echo "$STATUS" | jq -r '.workspaceHead // empty')"
          REMOTE_HASH="$(echo "$STATUS" | jq -r '.remoteCommitHash // empty')"

          : "${WORKSPACE_HEAD:?Missing workspaceHead}"
          : "${REMOTE_HASH:?Missing remoteCommitHash}"

          echo "workspace_head=$WORKSPACE_HEAD" >> "$GITHUB_OUTPUT"
          echo "remote_hash=$REMOTE_HASH" >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------
      # Fabric â€“ Update workspace from Git
      # ------------------------------------------------------------
      - name: Update Fabric workspace from Git
        shell: bash
        env:
          FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}
        run: |
          set -euo pipefail

          BODY="$(jq -n \
            --arg wh "${{ steps.fabric_git_status.outputs.workspace_head }}" \
            --arg rh "${{ steps.fabric_git_status.outputs.remote_hash }}" \
            '{
              workspaceHead: $wh,
              remoteCommitHash: $rh,
              conflictResolution: {
                conflictResolutionType: "Workspace",
                conflictResolutionPolicy: "PreferWorkspace"
              },
              options: { allowOverrideItems: true }
            }')"

          echo "$BODY" | jq .

          curl -fsS -X POST \
            "https://api.fabric.microsoft.com/v1/workspaces/${FABRIC_WORKSPACE_ID}/git/updateFromGit" \
            -H "Authorization: Bearer ${{ steps.fabric_token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "$BODY" \
            | jq .
