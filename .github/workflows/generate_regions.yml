name: Generate regional Power BI reports

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      # odpala się przy każdej zmianie w folderze template oraz config
      - 'template/**'
      - 'config/**'
      - 'scripts/**'
      - '.github/workflows/generate_regions.yml'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Generate regional PBIP projects
        shell: bash
        run: |
          set -euo pipefail
          python scripts/generate_regions.py

      - name: Commit & push generated outputs (if changed)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update regional PBIP outputs"
          git push

      # ----- Fabric: Update workspace from Git -----

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Get Fabric token (service principal) - with diagnostics
        id: fabric_token
        shell: bash
        run: |
          set -euo pipefail

          RESP=$(curl -sS -X POST "https://login.microsoftonline.com/${AZURE_TENANT_ID}/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=${AZURE_CLIENT_ID}" \
            -d "client_secret=${AZURE_CLIENT_SECRET}" \
            -d "grant_type=client_credentials" \
            -d "scope=https://api.fabric.microsoft.com/.default")

          echo "Token endpoint response:"
          echo "$RESP"

          TOKEN=$(python - <<'PY'
          import json, sys
          data = json.loads(sys.stdin.read())
          print(data.get("access_token",""))
          PY
                    <<< "$RESP")

                    if [ -z "$TOKEN" ]; then
                      echo "Failed to obtain access token. See response above (error/error_description)."
                      exit 1
                    fi

                    echo "token=$TOKEN" >> $GITHUB_OUTPUT
        env:
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}


      - name: Get Git status (Fabric)
        id: git_status
        shell: bash
        run: |
          set -euo pipefail
          STATUS=$(curl -sS -X POST \
            "https://api.fabric.microsoft.com/v1/workspaces/${FABRIC_WORKSPACE_ID}/git/getStatus" \
            -H "Authorization: Bearer ${{ steps.fabric_token.outputs.token }}" \
            -H "Content-Type: application/json")

          echo "$STATUS" | jq .

          WORKSPACE_HEAD=$(echo "$STATUS" | jq -r '.workspaceHead')
          REMOTE_HASH=$(echo "$STATUS" | jq -r '.remoteCommitHash')

          if [ -z "$WORKSPACE_HEAD" ] || [ "$WORKSPACE_HEAD" = "null" ]; then
            echo "workspaceHead missing. Git integration or Git credentials may not be configured for this principal."
            exit 1
          fi

          if [ -z "$REMOTE_HASH" ] || [ "$REMOTE_HASH" = "null" ]; then
            echo "remoteCommitHash missing. Check git integration status."
            exit 1
          fi

          echo "workspace_head=$WORKSPACE_HEAD" >> $GITHUB_OUTPUT
          echo "remote_hash=$REMOTE_HASH" >> $GITHUB_OUTPUT
        env:
          FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}

      - name: Update workspace from Git (Fabric)
        shell: bash
        run: |
          set -euo pipefail

          BODY=$(jq -n \
            --arg wh "${{ steps.git_status.outputs.workspace_head }}" \
            --arg rh "${{ steps.git_status.outputs.remote_hash }}" \
            '{
              workspaceHead: $wh,
              remoteCommitHash: $rh,
              conflictResolution: {
                conflictResolutionType: "Workspace",
                conflictResolutionPolicy: "PreferWorkspace"
              },
              options: {
                allowOverrideItems: true
              }
            }')

          echo "$BODY" | jq .

          RESP=$(curl -sS -i -X POST \
            "https://api.fabric.microsoft.com/v1/workspaces/${FABRIC_WORKSPACE_ID}/git/updateFromGit" \
            -H "Authorization: Bearer ${{ steps.fabric_token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          echo "$RESP"
        env:
          FABRIC_WORKSPACE_ID: ${{ secrets.FABRIC_WORKSPACE_ID }}
